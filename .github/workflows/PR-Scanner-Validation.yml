name: PR Scanner Validation (Feature->POC, Feature->DEV)

permissions:
  contents: read
  security-events: write

on:
  pull_request:
    branches: ["POC", "DEV"]
    paths:
      - "force-app/**"

jobs:
  validate-delta:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR HEAD
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch all history for accurate delta comparison

      - name: Ensure Base Branch is Available
        run: git fetch origin ${{ github.base_ref }}

      - name: Install Salesforce CLI + tools
        run: |
          npm install -g @salesforce/cli
          sudo apt-get update && sudo apt-get install -y jq

      - name: Install sfdx-git-delta
        run: |
          echo "y" | sf plugins install sfdx-git-delta
          sf plugins

      - name: Generate delta (PR base -> PR head)
        run: |
          rm -rf changed-sources
          mkdir -p changed-sources

          # Use origin/ branch references to ensure they exist locally
          FROM_SHA="origin/${{ github.base_ref }}"
          TO_SHA="${{ github.event.pull_request.head.sha }}"

          sf sgd source delta \
            --from "$FROM_SHA" \
            --to "$TO_SHA" \
            --output-dir "changed-sources" \
            --generate-delta \
            --source-dir "force-app"

          echo "Delta folder tree:"
          find changed-sources -maxdepth 4 -type d -print

      - name: Check for Salesforce Metadata Changes
        id: check_changes
        run: |
          FILE_COUNT=$(find changed-sources/force-app -type f | wc -l)
          if [ "$FILE_COUNT" -eq 0 ]; then
            echo "No Salesforce metadata files detected. Skipping validation."
            echo "has_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          echo "Found $FILE_COUNT file(s). Continuing..."
          echo "has_changes=true" >> $GITHUB_OUTPUT

      - name: Install Salesforce Code Analyzer
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          # Remove the retired v4 plugin to prevent flag conflicts
          sf plugins uninstall @salesforce/sfdx-scanner > /dev/null 2>&1 || true
          # Install the 2026 standard v5 plugin
          sf plugins install code-analyzer
          echo "Successfully installed Code Analyzer v5"

      - name: Run Code Analyzer (Compatible Mode)
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          # Run 1: SARIF
          # -t = target/path, -f = format/output-file
          sf code-analyzer run -t "changed-sources/force-app" -f sarif --outfile scanner-results.sarif || true
          
          # Run 2: JSON + Gating
          # -s = severity-threshold/fail-on-severity
          sf code-analyzer run -t "changed-sources/force-app" -f json --outfile scanner-results.json -s 1

      - name: Upload SARIF to GitHub Code Scanning
        # always() ensures this runs even if Run 2 failed the build
        if: always() && steps.check_changes.outputs.has_changes == 'true'
        uses: github/codeql-action/upload-sarif@v4 # Updated to v4 for 2026
        with:
          sarif_file: scanner-results.sarif

      - name: Upload SARIF to GitHub Code Scanning
        # always() ensures this runs even if 'Run Code Analyzer' failed the job
        if: always() && steps.check_changes.outputs.has_changes == 'true'
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: scanner-results.sarif

      - name: Upload analyzer reports as artifacts
        if: always() && steps.check_changes.outputs.has_changes == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: salesforce-code-analyzer-reports
          path: |
            scanner-results.sarif
            scanner-results.json
          if-no-files-found: warn

      - name: Select target org (POC/DEV) + create JWT key file
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          BASE="${{ github.base_ref }}"
          if [ "$BASE" = "POC" ]; then
            echo "SF_USERNAME=${{ secrets.NTSBPOC_USER_NAME }}" >> $GITHUB_ENV
            echo "SF_CONSUMER_KEY=${{ secrets.NTSBPOC_CONSUMER_KEY }}" >> $GITHUB_ENV
            echo "SF_INSTANCE_URL=${{ vars.NTSBPOC_URL }}" >> $GITHUB_ENV
            printf '%s' "${{ secrets.NTSBPOC_SERVER_KEY }}" > server.key
          elif [ "$BASE" = "DEV" ]; then
            echo "SF_USERNAME=${{ secrets.NTSBDEV_USER_NAME }}" >> $GITHUB_ENV
            echo "SF_CONSUMER_KEY=${{ secrets.NTSBDEV_CONSUMER_KEY }}" >> $GITHUB_ENV
            echo "SF_INSTANCE_URL=${{ vars.NTSBDEV_URL }}" >> $GITHUB_ENV
            printf '%s' "${{ secrets.NTSBDEV_SERVER_KEY }}" > server.key
          fi
          chmod 600 server.key

      - name: Authenticate (JWT)
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          sf org login jwt \
            --client-id "$SF_CONSUMER_KEY" \
            --jwt-key-file server.key \
            --username "$SF_USERNAME" \
            --instance-url "$SF_INSTANCE_URL" \
            --set-default

      - name: Validate delta deploy (dry-run)
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          sf project deploy start \
            --source-dir "changed-sources/force-app" \
            --test-level RunLocalTests \
            --dry-run
