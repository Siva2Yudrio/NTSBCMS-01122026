name: PR Validation (Feature->POC,Feature->DEV, DEV->QA, QA->UAT, UAT->main)

on:
  pull_request:
    branches: ["POC", "DEV", "QA", "UAT", "main"]
    paths:
      - "force-app/**"
  workflow_dispatch:

jobs:
  validate-delta:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR source (HEAD)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Debug branch context
        run: |
          echo "Base (target) branch: ${{ github.base_ref }}"
          echo "Head (source) branch: ${{ github.head_ref }}"
          echo "Event: ${{ github.event_name }}"
          git log -1 --oneline

      - name: Install Salesforce CLI
        run: |
          npm install -g @salesforce/cli
          sf --version

      - name: Install sfdx-git-delta
        run: |
          echo "y" | sf plugins install sfdx-git-delta
          sf plugins

      - name: Fetch base branch for delta
        run: |
          if [ -n "${{ github.base_ref }}" ]; then
            git fetch origin "${{ github.base_ref }}"
          else
            echo "[WARN] github.base_ref is empty (likely workflow_dispatch). Skipping base fetch."
          fi

      - name: Generate delta package vs base branch
        run: |
          rm -rf changed-sources
          mkdir -p changed-sources

          if [ -z "${{ github.base_ref }}" ]; then
            echo "[WARN] github.base_ref is empty (workflow_dispatch). Delta generation requires a base branch."
            echo "       Run this workflow from a PR, or enhance workflow_dispatch with a target branch input."
            exit 1
          fi

          sf sgd source delta \
            --to "HEAD" \
            --from "origin/${{ github.base_ref }}" \
            --output-dir "changed-sources" \
            --generate-delta \
            --source-dir "force-app"

          echo "[INFO] Delta generation complete."
          echo "[INFO] Delta contents:"
          ls -R changed-sources || true

      - name: Stop if no Salesforce changes detected
        run: |
          if [ ! -d "changed-sources/force-app" ]; then
            echo "No Salesforce changes detected in force-app. Skipping validation."
            exit 0
          fi

      - name: Select target org secrets based on PR base branch
        id: target
        run: |
          BASE="${{ github.base_ref }}"

          if [ -z "$BASE" ]; then
            echo "[WARN] BASE is empty (workflow_dispatch). Defaulting to DEV."
            BASE="DEV"
          fi

          echo "BASE_BRANCH=$BASE" >> $GITHUB_OUTPUT

          case "$BASE" in
            POC)
              echo "SF_USERNAME=${{ secrets.NTSBPOC_USER_NAME }}" >> $GITHUB_OUTPUT
              echo "SF_CONSUMER_KEY=${{ secrets.NTSBPOC_CONSUMER_KEY }}" >> $GITHUB_OUTPUT
              echo "SF_INSTANCE_URL=${{ vars.NTSBPOC_URL }}" >> $GITHUB_OUTPUT
              ;;
            DEV)
              echo "SF_USERNAME=${{ secrets.NTSBDEV_USER_NAME }}" >> $GITHUB_OUTPUT
              echo "SF_CONSUMER_KEY=${{ secrets.NTSBDEV_CONSUMER_KEY }}" >> $GITHUB_OUTPUT
              echo "SF_INSTANCE_URL=${{ vars.NTSBDEV_URL }}" >> $GITHUB_OUTPUT
              ;;
            QA)
              echo "SF_USERNAME=${{ secrets.NTSBQA_USER_NAME }}" >> $GITHUB_OUTPUT
              echo "SF_CONSUMER_KEY=${{ secrets.NTSBQA_CONSUMER_KEY }}" >> $GITHUB_OUTPUT
              echo "SF_INSTANCE_URL=${{ vars.NTSBQA_URL }}" >> $GITHUB_OUTPUT
              ;;
            UAT)
              echo "SF_USERNAME=${{ secrets.NTSBUAT_USER_NAME }}" >> $GITHUB_OUTPUT
              echo "SF_CONSUMER_KEY=${{ secrets.NTSBUAT_CONSUMER_KEY }}" >> $GITHUB_OUTPUT
              echo "SF_INSTANCE_URL=${{ vars.NTSBUAT_URL }}" >> $GITHUB_OUTPUT
              ;;
            main)
              echo "SF_USERNAME=${{ secrets.NTSBCMS_USER_NAME }}" >> $GITHUB_OUTPUT
              echo "SF_CONSUMER_KEY=${{ secrets.NTSBCMS_CONSUMER_KEY }}" >> $GITHUB_OUTPUT
              echo "SF_INSTANCE_URL=${{ vars.NTSBCMS_URL }}" >> $GITHUB_OUTPUT
              ;;
            *)
              echo "Unsupported PR base branch: $BASE"
              exit 1
              ;;
          esac

      - name: Authenticate to target org (JWT)
        run: |
          echo "${{ secrets.SF_JWT_KEY }}" > server.key

          sf org login jwt \
            --client-id "${{ steps.target.outputs.SF_CONSUMER_KEY }}" \
            --jwt-key-file server.key \
            --username "${{ steps.target.outputs.SF_USERNAME }}" \
            --instance-url "${{ steps.target.outputs.SF_INSTANCE_URL }}" \
            --set-default

          sf org display --verbose

      - name: Validate delta deployment (check-only)
        run: |
          sf project deploy start \
            --source-dir "changed-sources/force-app" \
            --test-level RunLocalTests \
            --dry-run

          echo "[INFO] Validation (check-only) completed."
