name: PR Validation (Feature->POC,Feature->DEV)

on:
  pull_request:
    branches: ["POC", "DEV"]
    paths:
      - "force-app/**"
  workflow_dispatch: {}

jobs:
  validate-delta:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR source (HEAD)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # Make checkout deterministic for PRs
          ref: ${{ github.event_name == 'pull_request' && github.event.pull_request.head.sha || github.ref }}

      - name: Debug branch context
        run: |
          echo "Base (target) branch: ${{ github.base_ref }}"
          echo "Head (source) branch: ${{ github.head_ref }}"
          echo "Event: ${{ github.event_name }}"
          git log -1 --oneline

      - name: Install Salesforce CLI
        run: |
          npm install -g @salesforce/cli
          sf --version

      - name: Install sfdx-git-delta
        run: |
          echo "y" | sf plugins install sfdx-git-delta
          sf plugins

      - name: Generate delta package vs base branch
        run: |
          rm -rf changed-sources
          mkdir -p changed-sources

          if [ "${{ github.event_name }}" != "pull_request" ]; then
            echo "[ERROR] workflow_dispatch is enabled but not configured with inputs."
            echo "        Run from a PR, or add inputs for base/head branches."
            exit 1
          fi

          FROM_SHA="${{ github.event.pull_request.base.sha }}"
          TO_SHA="${{ github.event.pull_request.head.sha }}"

          echo "[INFO] Delta FROM: $FROM_SHA"
          echo "[INFO] Delta TO:   $TO_SHA"

          sf sgd source delta \
            --from "$FROM_SHA" \
            --to "$TO_SHA" \
            --output-dir "changed-sources" \
            --generate-delta \
            --source-dir "force-app"

          echo "[INFO] Delta contents:"
          ls -R changed-sources || true

      - name: Stop if no Salesforce changes detected
        run: |
          if [ ! -d "changed-sources/force-app" ]; then
            echo "No Salesforce changes detected in force-app. Skipping validation."
            exit 0
          fi

      - name: Select target org secrets based on PR base branch
        run: |
          BASE="${{ github.base_ref }}"

          case "$BASE" in
            POC)
              echo "SF_USERNAME=${{ secrets.NTSBPOC_USER_NAME }}" >> $GITHUB_ENV
              echo "SF_CONSUMER_KEY=${{ secrets.NTSBPOC_CONSUMER_KEY }}" >> $GITHUB_ENV
              echo "SF_INSTANCE_URL=${{ vars.NTSBPOC_URL }}" >> $GITHUB_ENV
              echo "JWT_KEY=${{ secrets.NTSBPOC_SERVER_KEY }}" >> $GITHUB_ENV
              ;;
            DEV)
              echo "SF_USERNAME=${{ secrets.NTSBDEV_USER_NAME }}" >> $GITHUB_ENV
              echo "SF_CONSUMER_KEY=${{ secrets.NTSBDEV_CONSUMER_KEY }}" >> $GITHUB_ENV
              echo "SF_INSTANCE_URL=${{ vars.NTSBDEV_URL }}" >> $GITHUB_ENV
              echo "JWT_KEY=${{ secrets.NTSBDEV_SERVER_KEY }}" >> $GITHUB_ENV
              ;;
            *)
              echo "Unsupported PR base branch: $BASE"
              exit 1
              ;;
          esac

      - name: Prepare JWT key file
        run: |
          if [ -z "$JWT_KEY" ]; then
            echo "[ERROR] JWT_KEY is empty. Check NTSBPOC_SERVER_KEY / NTSBDEV_SERVER_KEY secrets."
            exit 1
          fi
          echo "$JWT_KEY" > server.key
          chmod 600 server.key

      - name: Authenticate to target org (JWT)
        run: |
          sf org login jwt \
            --client-id "$SF_CONSUMER_KEY" \
            --jwt-key-file server.key \
            --username "$SF_USERNAME" \
            --instance-url "$SF_INSTANCE_URL" \
            --set-default

          sf org display --verbose

      - name: Validate delta deployment (check-only)
        run: |
          sf project deploy start \
            --source-dir "changed-sources/force-app" \
            --test-level RunLocalTests \
            --dry-run

          echo "[INFO] Validation (check-only) completed."
